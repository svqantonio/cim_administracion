<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <title>Cambio tabla Mujeres - CIM</title>
        <link rel="stylesheet" href="css/women_changes.css">
        <script src="js/header.js"></script>
        <script src="js/libraries/sweetalert.js"></script>
        <script src="js/log_verification.js"></script>
    </head>
    <body>
        <div class="container">
            <button class="btn btn-link" onclick="window.location.href='main.html'"><- Volver</button>

            <!-- Buscador y filtrar -->
            <div id="buscar-filtrar">
                <input type="text" class="form-control" id="buscar" placeholder="Introduce parámetros sobre alguno de los campos de la tabla para buscar"/>
                <select class="form-select" id="filtrar" onchange="filtrado(this.value)">
                    <option disabled selected value="0">Opción de filtrado</option>
                    <option value="1">Nombre</option>
                    <option value="2">Apellidos</option>
                    <option value="3">Dni</option>
                    <option value="4">Fecha de nacimiento</option>
                    <option value="5">Dirección</option>
                </select>
            </div>
            
            <table id="women_table" class="table table-hover table-success" style="border: 1px solid black">
                <thead>
                    <tr>
                        <th>Id</th>
                        <th>Nombre</th>
                        <th>Apellidos</th>
                        <th>Dni</th>
                        <th>Fecha de nacimiento</th>
                        <th>Dirección</th>
                        <th>Editar</th>
                        <th>Borrar</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <script>
            function filtrado(filtro) {
                console.log("Filtro: ", filtro);
                var xhr = new XMLHttpRequest();
                xhr.open('POST', 'manage_tables.php?table=mujeres', true);
            }

            document.addEventListener('DOMContentLoaded', function() {
                const parameters = new URLSearchParams(window.location.search);
                const table = parameters.get('table');
                var xhr = new XMLHttpRequest();
                xhr.open('POST', 'manage_tables.php?table=' + table, true);
                xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=utf-8");
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            var women_table = document.getElementById('women_table');
                            var response = JSON.parse(xhr.responseText);

                            response.forEach(function(response) {
                                var tr = document.createElement('tr');
                                var idTD = document.createElement('td');
                                idTD.textContent = response.id;

                                var nameTD = document.createElement('td');
                                nameTD.textContent = response.nombre;

                                var secondNameTD = document.createElement('td');
                                secondNameTD.textContent = response.apellidos;

                                var dniTD = document.createElement('td');
                                dniTD.textContent = response.dni;

                                var birth_dateTD = document.createElement('td');
                                birth_dateTD.textContent = response.fecha_nac;

                                var directionTD = document.createElement('td');
                                directionTD.textContent = response.direccion;

                                var editButtonTD = document.createElement('td');
                                var editButton = document.createElement('button');
                                editButton.textContent = "Editar";
                                editButton.onclick = function() {
                                    window.location.href = 'women_changes_id.html?table=mujeres&id=' + response.id;
                                };
                                editButtonTD.appendChild(editButton);

                                var deleteButtonTD = document.createElement('td');
                                var deleteButton = document.createElement('button');
                                deleteButton.textContent = 'Borrar';
                                deleteButton.onclick = function() {
                                    Swal.fire({
                                        title: "¿Estás seguro de que quieres borrar a esta usuaria?",
                                        icon: "warning",
                                        showCancelButton: true,
                                        confirmButtonColor: "#3085d6",
                                        cancelButtonColor: "#d33",
                                        confirmButtonText: "Borrar",
                                        cancelButtonText: "Cancelar"
                                    }).then((result) => {
                                        if (result.isConfirmed) {
                                            var xhr = new XMLHttpRequest();
                                            xhr.open("POST", "manage_tables.php?table=" + table + "&id=" + response.id + "&function=women_delete", true);
                                            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                                            xhr.onreadystatechange = function() {
                                                if (xhr.readyState === 4) {
                                                    if (xhr.status === 200) {
                                                        var response = JSON.parse(xhr.responseText);
                                                        Swal.fire({
                                                            position: "center",
                                                            title: response.message,
                                                            icon: response.status,
                                                            timer: response.timer
                                                        });
                                                        setTimeout(function() {
                                                            location.reload(true);
                                                        }, response.timer);
                                                    }
                                                }
                                            }
                                            xhr.send();
                                        } 
                                    });
                                    return false;
                                };
                                deleteButtonTD.appendChild(deleteButton);

                                tr.appendChild(idTD); tr.appendChild(nameTD); tr.appendChild(secondNameTD); tr.appendChild(dniTD); tr.appendChild(birth_dateTD); tr.appendChild(directionTD); tr.appendChild(editButtonTD); tr.appendChild(deleteButtonTD);
                                women_table.appendChild(tr);
                            });
                        }
                    }
                };
                xhr.send();
            });
        </script>
    </body>
</html>