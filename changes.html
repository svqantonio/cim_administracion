<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <!--<link rel="stylesheet" href="css/changes.css">-->
        <script src="js/header.js"></script>
        <script src="js/redirect.js"></script>
        <title>Cambios en tablas - CIM</title>
    </head>
    <body>
        <div class="container">
            <button class="btn btn-link" onclick="window.history.back()"><- Volver</button>
            <table id="tabla_bbdd" class="table table-success" border="1px solid black">
                <thead>
                    <tr>
                        <th>Id</th>
                        <th>Valor</th>
                        <th>Editar</th>
                        <th>Borrar</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                const parametros = new URLSearchParams(window.location.search);
                                const tabla = parametros.get('table');
                                var xhr = new XMLHttpRequest();
                                xhr.open("POST", 'changes.php?table=' + tabla, true);
                                xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=utf-8");
                                xhr.onreadystatechange = function() {
                                    if (xhr.readyState === 4) {
                                        if (xhr.status === 200) {
                                            var dataTable = JSON.parse(xhr.responseText);
                                            var tabla_bbdd = document.getElementById('tabla_bbdd');
                                            var editForm = document.getElementById('editForm');
                                            
                                            dataTable.forEach(function(response) {
                                                var tr = document.createElement('tr');

                                                var idTD = document.createElement('td');
                                                idTD.textContent = response.id;

                                                var valorTD = document.createElement('td');
                                                valorTD.textContent = response.valor.toUpperCase();

                                                var editButtonTD = document.createElement('td');
                                                var editButton = document.createElement('button');
                                                editButton.textContent = 'Editar';
                                                editButton.onclick = function() {
                                                    var idFormEdit = document.getElementById('idFormEdit');
                                                    var valorFormEdit = document.getElementById('valorFormEdit');
                                                    idFormEdit.value = response.id;
                                                    valorFormEdit.value = response.valor;
                                                    tabla_bbdd.style.display = 'none'; editForm.style.display = 'block';

                                                };
                                                editButtonTD.appendChild(editButton);

                                                var deleteButtonTD = document.createElement('td');
                                                var deleteButton = document.createElement('button');
                                                deleteButton.textContent = "Borrar";
                                                deleteButton.onclick = function() {
                                                    Swal.fire({
                                                        title: "¿Estás seguro de que quieres BORRARLO?",
                                                        icon: "warning",
                                                        showCancelButton: true,
                                                        confirmButtonColor: "#3085d6",
                                                        cancelButtonColor: "#d33",
                                                        confirmButtonText: "Borrar",
                                                        cancelButtonText: "Cancelar"
                                                    }).then((result) => {
                                                        if (result.isConfirmed) {
                                                            var xhr = new XMLHttpRequest();
                                                            xhr.open("POST", 'changes.php?table=' + tabla + "&id=" + response.id, true);
                                                            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=utf-8");
                                                            xhr.onreadystatechange = function() {
                                                                if (xhr.readyState === 4) {
                                                                    if (xhr.status === 200) {
                                                                        var response = JSON.parse(xhr.responseText);
                                                                        console.log(response);
                                                                        Swal.fire({
                                                                            position: 'center',
                                                                            title: response.message,
                                                                            icon: response.status,
                                                                            showConfirmButton: false,
                                                                            timer: response.timer
                                                                        });
                                                                        setTimeout(function() {
                                                                            location.reload(true);
                                                                        }, response.timer);
                                                                    } 
                                                                }
                                                            }
                                                            xhr.send();
                                                        }
                                                    });
                                                };
                                                deleteButtonTD.appendChild(deleteButton);

                                                tr.appendChild(idTD);
                                                tr.appendChild(valorTD);
                                                tr.appendChild(editButtonTD);
                                                tr.appendChild(deleteButtonTD);
                                                tabla_bbdd.appendChild(tr);
                                            }); 
                                        }
                                    }
                                }
                                xhr.send();
                            });
                        </script>
                    </tr>
                </tbody>
            </table>
            <form id="editForm" onsubmit="return validateForm()" style="display: none;">
                <h3>Formulario de edición</h3>
                <input type="number" id="idFormEdit" required name="id" style="display: none;" />
                <div class="form-control">
                    <label class="form-label">Valor</label>
                    <input type="text" id="valorFormEdit" required name="valor" style="width: 50%" />
                </div>
                <button type="submit" id="btnSubmit" class="btn btn-primary">Editar</button>
                <button type="button" id="btnBack" class="btn btn-secondary" onclick="tabla_bbdd.style.display = 'block'; editForm.style.display = 'none';">Volver</button>
            </form>
            <script>
                function validateForm() {
                    Swal.fire({
                        title: "¿Estos son los datos que quieres EDITAR?",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#3085d6",
                        cancelButtonColor: "#d33",
                        confirmButtonText: "Editar",
                        cancelButtonText: "Cancelar"
                    }).then((result) => {
                        if (result.isConfirmed) {
                            const parametros = new URLSearchParams(window.location.search);
                            const tabla = parametros.get('table');
                            var id = document.getElementById('idFormEdit').value;
                            var valor = document.getElementById('valorFormEdit').value;
                            console.log("Id: ", id , " valor: ", valor);
                            var xhr = new XMLHttpRequest();
                            xhr.open("POST", 'changes.php?table=' + tabla + "&id=" + id + "&valor=" + valor, true);
                            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=utf-8");
                            xhr.onreadystatechange = function() {
                                if (xhr.readyState === 4) {
                                    if (xhr.status === 200) {
                                        var response = JSON.parse(xhr.responseText);
                                        Swal.fire({
                                            position: 'center',
                                            title: response.message,
                                            icon: response.status,
                                            showConfirmButton: false,
                                            timer: response.timer
                                        });
                                        setTimeout(function() {
                                            location.reload(true);
                                        }, response.timer);
                                    } 
                                }
                            }
                            xhr.send();
                        }
                    });
                    return false;
                }
            </script>
        </div>
    </body>
</html>